name: Deploy to  staging server
run-name: Deploy Moodle (dev) branch to  server

on:
  push:
    branches: [dev]
  workflow_dispatch:

jobs:
  deploy-to-ubuntu:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ› ï¸ Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          printf "%s" "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -T 10 -p 22 54.91.141.135 >> ~/.ssh/known_hosts || true

      - name: ðŸš€ Deploy to Ubuntu Server 24
        run: |
          ssh -T -i ~/.ssh/id_rsa -p 22 -o StrictHostKeyChecking=no root@54.91.141.135 << 'EOF'

          set -e
          APP_PATH="/var/www/moodle"
          PHP_BIN="/usr/bin/php8.1"

          echo "ðŸš€ Starting deployment to Ubuntu 24..."
          cd $APP_PATH

          echo "ðŸ“¥ Pulling latest Moodle code..."
          git fetch origin dev && git reset --hard origin/dev || true

          # Check Composer
          if [ ! -x "$(command -v composer)" ]; then
            echo "Installing Composer..."
            curl -sS https://getcomposer.org/installer | $PHP_BIN
            mv composer.phar /usr/local/bin/composer
          fi

          echo "ðŸ“¦ Installing PHP dependencies..."
          composer install --no-dev --no-interaction --prefer-dist --optimize-autoloader || true

          echo "ðŸ”§ Enabling Moodle maintenance mode..."
          $PHP_BIN admin/cli/maintenance.php --enable || true

          echo "ðŸ—„ï¸ Running Moodle upgrade..."
          $PHP_BIN admin/cli/upgrade.php --non-interactive --allow-unstable || true

          echo "ðŸ§¹ Purging Moodle caches..."
          $PHP_BIN admin/cli/purge_caches.php || true

          echo "ðŸ” Fixing file permissions..."
          chown -R www-data:www-data $APP_PATH
          find $APP_PATH -type f -exec chmod 644 {} \;
          find $APP_PATH -type d -exec chmod 755 {} \;

          echo "â™»ï¸ Restarting PHP-FPM..."
          systemctl reload php8.1-fpm || true

          echo "ðŸš€ Disabling maintenance mode..."
          $PHP_BIN admin/cli/maintenance.php --disable || true

          echo "âœ… Deployment completed successfully! ðŸŽ‰"
          EOF
